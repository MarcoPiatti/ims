services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    hostname: mysql
    ports:
      - '3306:3306'
    environment:
      MYSQL_ROOT_PASSWORD: debezium
      MYSQL_USER: mysqluser
      MYSQL_PASSWORD: mysqlpw
    volumes:
      - ./conf/store_schema.sql:/docker-entrypoint-initdb.d/store_schema.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-pdebezium"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-central:
    image: mysql:8.0
    container_name: mysql-central
    hostname: mysql-central
    ports:
      - '3307:3306'
    environment:
      MYSQL_ROOT_PASSWORD: centralpw
      MYSQL_USER: centraluser
      MYSQL_PASSWORD: centralpw
    volumes:
      - ./conf/central_schema.sql:/docker-entrypoint-initdb.d/central_schema.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-pcentralpw"]
      interval: 10s
      timeout: 5s
      retries: 5

  zookeeper:
    image: confluentinc/cp-zookeeper:5.5.3
    container_name: zookeeper
    hostname: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - '2181:2181'
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-enterprise-kafka:5.5.3
    container_name: kafka
    hostname: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    links:
      - zookeeper
    ports:
      - '9092:9092'
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 10

  schema-registry:
    container_name: schema-registry
    hostname: schema-registry
    image: confluentinc/cp-schema-registry:4.0.3
    environment:
      - SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL=zookeeper:2181
      - SCHEMA_REGISTRY_HOST_NAME=schema-registry
      - SCHEMA_REGISTRY_LISTENERS=http://schema-registry:8081
    ports:
      - '8081:8081'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/subjects"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      kafka:
        condition: service_healthy
      zookeeper:
        condition: service_healthy

  kafka-connect:
    container_name: kafka-connect
    hostname: kafka-connect
    image: debezium/connect:1.8
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - '8083:8083'
    environment:
      - BOOTSTRAP_SERVERS=kafka:9092
      - GROUP_ID=medium_debezium
      - CONFIG_STORAGE_TOPIC=my_connect_configs
      - CONFIG_STORAGE_REPLICATION_FACTOR=1
      - OFFSET_STORAGE_TOPIC=my_connect_offsets
      - OFFSET_STORAGE_REPLICATION_FACTOR=1
      - STATUS_STORAGE_TOPIC=my_connect_statuses
      - STATUS_STORAGE_REPLICATION_FACTOR=1
      - REST_ADVERTISED_HOST_NAME=medium_debezium
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/connectors"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181  # optional if using old Kafka
      KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: PLAINTEXT
    depends_on:
      kafka:
        condition: service_healthy
      zookeeper:
        condition: service_healthy

  connector-sender:
    container_name: connector-sender
    image: confluentinc/cp-kafka-connect:5.5.3
    volumes:
      - ./conf:/conf
    depends_on:
      kafka-connect:
        condition: service_healthy
    command:
      - bash
      - -c
      - |
        echo "Waiting for kafka connect to start..."
        until [[ "$$(curl -s -o /dev/null -w %{http_code} kafka-connect:8083/connectors)" -eq 200 ]]; do
          sleep 1
        done
        echo -e "Sending connectors"
        curl -X DELETE kafka-connect:8083/connectors/store-outbox-connector
        curl -X DELETE kafka-connect:8083/connectors/store-availability-connector
        curl -i -X POST -H "Accept:application/json" -H "Content-Type:application/json" kafka-connect:8083/connectors/ -d @/conf/store_availability_connector.json
        curl -i -X POST -H "Accept:application/json" -H "Content-Type:application/json" kafka-connect:8083/connectors/ -d @/conf/store_update_connector.json
    restart: "no"

  store-stock-update:
    build:
      context: ./store-stock-update
    container_name: store-stock-update
    hostname: store-stock-update
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - '9300:9290'
    healthcheck:
      test: ["CMD", "curl", "-fsSL", "http://localhost:9290/health-check"]
      interval: 10s
      timeout: 5s
      retries: 5

  central-stock-update:
    build:
      context: ./central-stock-update
    container_name: central-stock-update
    hostname: central-stock-update
    depends_on:
      kafka:
        condition: service_healthy
      mysql-central:
        condition: service_healthy


  central-query-service:
    build:
      context: ./central-query-service
    container_name: central-query-service
    hostname: central-query-service
    depends_on:
      mysql-central:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - '9301:9290'
    healthcheck:
      test: ["CMD", "curl", "-fsSL", "http://localhost:9290/health-check"]
      interval: 10s
      timeout: 5s
      retries: 5